name: Deploy Backend to AppRun

on:
  push:
    branches:
      - deploy
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Sakura Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.SAKURA_CONTAINER_REGISTRY_FQDN }}
          username: ${{ secrets.SAKURA_CONTAINER_REGISTRY_USERNAME }}
          password: ${{ secrets.SAKURA_CONTAINER_REGISTRY_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile.prod
          push: true
          tags: ${{ secrets.SAKURA_CONTAINER_REGISTRY_FQDN }}/healthcare-backend:latest,${{ secrets.SAKURA_CONTAINER_REGISTRY_FQDN }}/healthcare-backend:${{ github.sha }}
          platforms: linux/amd64
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Trigger AppRun deployment
        run: |
          curl -X PUT \
            "https://secure.sakura.ad.jp/cloud/zone/is1a/api/cloud/1.1/apprun/${{ secrets.SAKURA_APPRUN_ID }}/deploy" \
            -u "${{ secrets.SAKURA_API_TOKEN }}:${{ secrets.SAKURA_API_SECRET }}" \
            -H "Content-Type: application/json"

      - name: Wait for deployment
        run: |
          echo "Waiting for AppRun to deploy new image..."
          sleep 30

          # Check health status
          for i in {1..10}; do
            STATUS=$(curl -s "https://secure.sakura.ad.jp/cloud/zone/is1a/api/cloud/1.1/apprun/${{ secrets.SAKURA_APPRUN_ID }}" \
              -u "${{ secrets.SAKURA_API_TOKEN }}:${{ secrets.SAKURA_API_SECRET }}" | jq -r '.AppRun.Status')
            echo "Deployment status: $STATUS"

            if [ "$STATUS" = "Running" ]; then
              echo "✓ AppRun is running!"
              exit 0
            fi

            sleep 10
          done

          echo "⚠ Deployment may still be in progress"

      - name: Deploy notification
        run: |
          echo "Backend deployed successfully!"
          echo "Image: ${{ secrets.SAKURA_CONTAINER_REGISTRY_FQDN }}/healthcare-backend:${{ github.sha }}"
          echo "URL: https://app-${{ secrets.SAKURA_APPRUN_ID }}.ingress.apprun.sakura.ne.jp"
